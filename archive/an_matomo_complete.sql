-- superseded since 2021-07-03

SELECT
	CAST(matomo_log_visit.idvisit AS BIGINT),
	ENCODE(DECODE(matomo_log_visit.idvisitor,'base64'),'hex')::TEXT AS idvisitor, -- HEX type in mysql
	CAST(matomo_log_link_visit_action.idlink_va AS BIGINT),
	CAST(matomo_log_action.idaction AS INT),
	CAST(matomo_log_conversion.idgoal AS INT),
	CAST(matomo_log_conversion.idorder AS INT) AS order_no,
	matomo_log_action.name,
	CAST(matomo_log_action.hash AS BIGINT), -- INT out of range, use BIGINT
	CAST(matomo_log_action.type AS SMALLINT),
	CAST(matomo_log_action.url_prefix AS SMALLINT),
	matomo_log_conversion.url,
	CAST(matomo_log_conversion.items AS SMALLINT),
	CAST(matomo_log_conversion.buster AS BIGINT), -- INT out of range, use BIGINT
	matomo_log_conversion.revenue,
	matomo_log_conversion.revenue_tax,
	matomo_log_conversion.revenue_discount,
	matomo_log_conversion.revenue_shipping,
	matomo_log_conversion.revenue_subtotal,
	matomo_log_conversion_item.price,
	CAST(matomo_log_conversion_item.deleted AS SMALLINT),
	CAST(matomo_log_conversion_item.idorder AS INT) AS order_no_conversion_item,
	CAST(matomo_log_conversion_item.quantity AS INT),
	CAST(matomo_log_conversion_item.idaction_sku AS INT),
	CAST(matomo_log_conversion_item.idaction_name AS INT) AS idaction_name_conversion_item,
	CAST(matomo_log_conversion_item.idaction_category AS INT),
	CAST(matomo_log_conversion_item.idaction_category2 AS INT),
	CAST(matomo_log_conversion_item.idaction_category3 AS INT),
	CAST(matomo_log_conversion_item.idaction_category4 AS INT),
	CAST(matomo_log_conversion_item.idaction_category5 AS INT),
	matomo_log_link_visit_action.idpageview,
	matomo_log_link_visit_action.search_cat,
	CAST(matomo_log_link_visit_action.time_spent AS INT),
	TO_TIMESTAMP(LEFT(matomo_log_link_visit_action.server_time::TEXT,-3)::INT)::TIMESTAMP AS server_time,
	CAST(matomo_log_link_visit_action.time_server AS INT),
	matomo_log_link_visit_action.custom_float,
	CAST(matomo_log_link_visit_action.search_count AS INT),
	CAST(matomo_log_link_visit_action.time_network AS INT),
	CAST(matomo_log_link_visit_action.time_on_load AS INT),
	CAST(matomo_log_link_visit_action.idaction_name AS INT) AS idaction_name_log_link,
	matomo_log_link_visit_action.product_price,
	CAST(matomo_log_link_visit_action.time_transfer AS INT),
	CAST(matomo_log_link_visit_action.idaction_url_ref AS INT),
	CAST(matomo_log_link_visit_action.idaction_name_ref AS INT),
	CAST(matomo_log_link_visit_action.pageview_position AS INT),
	CAST(matomo_log_link_visit_action.time_dom_completion AS INT),
	CAST(matomo_log_link_visit_action.time_dom_processing AS INT),
	CAST(matomo_log_link_visit_action.idaction_product_cat AS INT),
	CAST(matomo_log_link_visit_action.idaction_product_sku AS INT),
	CAST(matomo_log_link_visit_action.idaction_content_name AS INT),
	CAST(matomo_log_link_visit_action.idaction_event_action AS INT),
	CAST(matomo_log_link_visit_action.idaction_product_cat2 AS INT),
	CAST(matomo_log_link_visit_action.idaction_product_cat3 AS INT),
	CAST(matomo_log_link_visit_action.idaction_product_cat4 AS INT),
	CAST(matomo_log_link_visit_action.idaction_product_cat5 AS INT),
	CAST(matomo_log_link_visit_action.idaction_product_name AS INT),
	CAST(matomo_log_link_visit_action.time_spent_ref_action AS INT),
	CAST(matomo_log_link_visit_action.idaction_content_piece AS INT),
	CAST(matomo_log_link_visit_action.idaction_content_target AS INT),
	CAST(matomo_log_link_visit_action.idaction_event_category AS INT),
	CAST(matomo_log_link_visit_action.idaction_content_interaction AS INT),
	CAST(matomo_log_visit.idsite AS INT),
	matomo_log_visit.user_id,
	ENCODE(DECODE(matomo_log_visit.config_id,'base64'),'hex')::TEXT AS config_id, -- HEX type in mysql
	matomo_log_visit.config_os,
	matomo_log_visit.config_pdf,
	matomo_log_visit.profilable,
	matomo_log_visit.campaign_id,
	matomo_log_visit.config_java,
	'0.0.0.0'::inet + ('x' || lpad(ENCODE(DECODE(matomo_log_visit.location_ip,'base64'),'hex'), 8, '0'))::bit(32)::bigint AS location_ip, -- INET type, i am a smartboi
	matomo_log_visit.referer_url,
	matomo_log_visit.config_flash,
	matomo_log_visit.referer_name,
	CAST(matomo_log_visit.referer_type AS SMALLINT),
	matomo_log_visit.campaign_name,
	matomo_log_visit.config_cookie,
	matomo_log_visit.location_city,
	matomo_log_visit.campaign_group,
	CAST(matomo_log_visit.last_idlink_va AS BIGINT),
	matomo_log_visit.campaign_medium,
	matomo_log_visit.campaign_source,
	matomo_log_visit.location_region,
	matomo_log_visit.referer_keyword,
	matomo_log_visit.campaign_content,
	matomo_log_visit.campaign_keyword,
	matomo_log_visit.config_quicktime,
	matomo_log_visit.location_country,
	matomo_log_visit.visit_goal_buyer,
	CAST(matomo_log_visit.visit_total_time AS INT),
	matomo_log_visit.config_os_version,
	matomo_log_visit.config_realplayer,
	matomo_log_visit.config_resolution,
	matomo_log_visit.location_latitude,
	TO_TIMESTAMP(LEFT(matomo_log_visit.visitor_localtime::text,-3)::int)::TIME AS visitor_localtime,
	matomo_log_visit.visitor_returning,
	matomo_log_visit.campaign_placement,
	matomo_log_visit.config_client_type,
	CAST(matomo_log_visit.config_device_type AS SMALLINT),
	matomo_log_visit.config_silverlight,
	matomo_log_visit.custom_dimension_1,
	matomo_log_visit.custom_dimension_2,
	matomo_log_visit.custom_dimension_3,
	matomo_log_visit.custom_dimension_4,
	matomo_log_visit.custom_dimension_5,
	matomo_log_visit.location_longitude,
	CAST(matomo_log_visit.visit_total_events AS INT),
	matomo_log_visit.config_browser_name,
	matomo_log_visit.config_device_brand,
	matomo_log_visit.config_device_model,
	matomo_log_visit.config_windowsmedia,
	CAST(matomo_log_visit.visit_total_actions AS INT),
	matomo_log_visit.visit_goal_converted,
	CAST(matomo_log_visit.visit_total_searches AS SMALLINT),
	CAST(matomo_log_visit.visitor_count_visits AS INT),
	matomo_log_visit.config_browser_engine,
	matomo_log_visit.location_browser_lang,
	matomo_log_visit.config_browser_version,
	TO_TIMESTAMP(LEFT(matomo_log_visit.visit_last_action_time::TEXT,-3)::INT)::TIMESTAMP AS visit_last_action_time,
	CAST(matomo_log_visit.visit_exit_idaction_url AS INT),
	TO_TIMESTAMP(LEFT(matomo_log_visit.visit_first_action_time::TEXT,-3)::INT)::TIMESTAMP AS visit_first_action_time,
	CAST(matomo_log_visit.visit_entry_idaction_url AS INT),
	CAST(matomo_log_visit.visit_exit_idaction_name AS INT),
	CAST(matomo_log_visit.visit_total_interactions AS INT),
	CAST(matomo_log_visit.visit_entry_idaction_name AS INT),
	CAST(matomo_log_visit.visitor_seconds_since_last AS INT),
	CAST(matomo_log_visit.visitor_seconds_since_first AS INT),
	CAST(matomo_log_visit.visitor_seconds_since_order AS INT)
FROM matomo.matomo_log_visit AS matomo_log_visit
LEFT JOIN matomo.matomo_log_link_visit_action AS matomo_log_link_visit_action ON matomo_log_visit.idvisit = matomo_log_link_visit_action.idvisit
LEFT JOIN matomo.matomo_log_action AS matomo_log_action ON matomo_log_action.idaction = matomo_log_link_visit_action.idaction_url
LEFT JOIN matomo.matomo_log_conversion AS matomo_log_conversion ON matomo_log_visit.idvisit = matomo_log_conversion.idvisit
LEFT JOIN matomo.matomo_log_conversion_item AS matomo_log_conversion_item ON matomo_log_visit.idvisit = matomo_log_conversion_item.idvisit

WHERE matomo_log_visit.idsite='1'
