WITH fulfillrite AS (
	SELECT
		ref_no,
		ABS(ROUND(SUM(amount::NUMERIC),2)) AS fulfillment_costs
	FROM fulfillrite.fulfillrite
	WHERE ref_no != '0'
	GROUP BY ref_no
)


SELECT
	o.order_id,
	o.order_no,
	o.status,
	o.net_total,
	o.parent_id,
	o.tax_total,
	o.customer_id,
	o.total_sales,
	o.date_created,
	o.num_items_sold,
	o.shipping_total,
	o.date_created_gmt,
	o.returning_customer,
	o.order_key,
	o.payment_method,
	o.payment_method_title,
	o.customer_ip_address,
	o.customer_user_agent,
	o.cart_hash,
	o.billing_first_name,
	o.billing_last_name,
	o.billing_address_1,
	o.billing_city,
	o.billing_state,
	o.billing_postcode,
	o.billing_country,
	o.billing_email,
	o.shipping_first_name,
	o.shipping_last_name,
	o.shipping_address_1,
	o.shipping_city,
	o.shipping_state,
	o.shipping_postcode,
	o.shipping_country,
	o.order_currency,
	o.cart_discount,
	o.payment_intent_id,
	o.payment_method_token,
	o.wc_stripe_mode,
	o.wc_stripe_charge_status,
	o.week_day,
	o.week_hour,
	o.iso_geo_state,
	o.transaction_id AS stripe_id,
	s.status AS stripe_status,
	s.date_created AS stripe_date_created,
	s.charge_type,
	s.reason,
	s.risk_level,
	s.network_status,
	s.seller_message,
	s.order_id AS stripe_order_id,
	s.failure_code,
	s.failure_message,
	s.payment_intent,
	s.refund_amount,
	s.card_brand,
	s.last4,
	s.cvc_check,
	s.address_line1_check,
	s.address_postal_code_check,
	s.balance_transaction,
	s.trx_type,
	s.exchange_rate,
	s.currency_src,
	s.amount AS stripe_amount,
	s.fee_src,
	s.net_src,
	s.amount_src,
	s.currency_home,
	s.fee_home,
	s.net_home,
	s.amount_home,
	f.fulfillment_costs,
	s.net_src-COALESCE(f.fulfillment_costs,0) AS remaining_balance

FROM {{ref('an_orders_complete')}} AS o
LEFT JOIN {{ref('an_stripe')}} AS s ON o.transaction_id = s.id
LEFT JOIN fulfillrite AS f ON o.order_no = f.ref_no
WHERE o.status IN ('wc-completed','wc-processing')
